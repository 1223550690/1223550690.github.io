<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart LoRa Irrigation Digital Twin v5.0 (Datasheet Integrated)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --primary: #3498db;
            --energy: #f1c40f;
            --lora: #9b59b6;
            --danger: #e74c3c;
            --success: #2ecc71;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --border: 1px solid #e1e4e8;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
            --log-height: 160px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', 'Roboto', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden; 
            display: grid;
            grid-template-rows: 60px 1fr var(--log-height);
            transition: grid-template-rows 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body.log-hidden { grid-template-rows: 60px 1fr 30px; }

        header {
            background: var(--panel-bg);
            border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-shadow: var(--shadow); z-index: 100;
        }

        .brand { font-size: 20px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--lora); background: rgba(155, 89, 182, 0.1); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .sim-controls { display: flex; gap: 15px; align-items: center; }
        select, button, input[type="time"] {
            background: #f8f9fa; border: 1px solid #ced4da; color: var(--text-main);
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-family: inherit; transition: all 0.2s;
        }
        button:hover { background: #e9ecef; }
        button.active { background: var(--success); color: white; border-color: var(--success); }
        button.stop { background: var(--danger); color: white; border-color: var(--danger); }

        .main-workspace {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 20px; padding: 20px;
            min-height: 0; height: 100%; overflow: hidden; z-index: 1;
        }

        .panel-box {
            background: var(--panel-bg); border-radius: 8px; border: var(--border);
            box-shadow: var(--shadow); padding: 15px; display: flex; flex-direction: column;
            position: relative; overflow: hidden; height: 100%;
        }
        .panel-header { font-size: 14px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; flex-shrink: 0; }

        .settings-form { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; flex: 1; }
        .form-section { background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; flex-shrink: 0; }
        .form-section.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        
        .section-title { font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 8px; display: block; border-bottom: 1px dashed #ddd; padding-bottom: 4px;}
        .form-label { font-size: 12px; color: var(--text-main); margin-bottom: 4px; display: flex; justify-content: space-between; }
        input[type="range"] { width: 100%; accent-color: var(--primary); cursor: pointer; }
        input[type="checkbox"] { accent-color: var(--danger); transform: scale(1.2); cursor: pointer; }
        
        /* Farm Grid Update */
        .field-wrapper { overflow-y: auto; }
        .farm-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 4px;
            width: 100%; height: 100%; 
            background: #e8dcc6; border: 8px solid #d4c5a9;
            padding: 10px; border-radius: 4px; position: relative; box-sizing: border-box;
        }
        
        .crop-unit {
            background-color: #fff; 
            border: 1px solid rgba(0,0,0,0.1); border-radius: 2px;
            position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: background-color 0.5s; 
        }
        
        .nozzle { width: 12px; height: 12px; background: rgba(0,0,0,0.2); border-radius: 50%; position: absolute; }
        .crop-unit.watering .nozzle { background: var(--primary); box-shadow: 0 0 15px var(--primary); transform: scale(1.2); }
        
        /* Optimized Sensor Overlay */
        .sensor-overlay {
            position: absolute; 
            width: 48px; height: 48px;
            background: rgba(44, 62, 80, 0.85);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            color: #fff;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .sensor-overlay:hover { transform: scale(1.15); background: var(--lora); box-shadow: 0 0 15px var(--lora); }
        .sensor-overlay::after {
            content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.5);
            animation: ripple 2s infinite; opacity: 0; z-index: -1;
        }
        
        .sensor-overlay i { font-size: 14px; margin-bottom: 2px; }
        .sensor-overlay .val { font-size: 10px; font-weight: bold; font-family: monospace; color: var(--success); }

        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .topo-visual {
            flex: 1; min-height: 0;
            display: flex; flex-direction: column; gap: 8px; 
            overflow-y: auto; margin-bottom: 10px;
        }
        .comp-card {
            width: 100%; background: white; border: 1px solid #eee; padding: 8px; border-radius: 6px;
            display: flex; align-items: center; gap: 10px; cursor: help; transition: all 0.2s; position: relative;
            flex-shrink: 0;
        }
        .comp-card:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .comp-icon { width: 32px; height: 32px; background: #f1f2f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #555; }
        .comp-info { flex: 1; }
        .comp-info h4 { margin: 0; font-size: 12px; color: var(--text-main); }
        .comp-info p { margin: 1px 0 0; font-size: 10px; color: var(--text-sub); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #ccc; margin-left: auto; }
        .status-dot.on { background: var(--success); box-shadow: 0 0 5px var(--success); }

        .sensor-table { width: 100%; font-size: 10px; border-collapse: collapse; margin-top: 5px; }
        .sensor-table td { padding: 2px 4px; border-bottom: 1px dashed #eee; }
        .sensor-table td:last-child { text-align: right; font-weight: bold; color: var(--primary); }

        .stats-divider { border-top: 2px dashed #e1e4e8; margin: 5px 0 10px 0; }
        .stats-container {
            flex: 1; min-height: 0;
            display: flex; flex-direction: column; gap: 8px;
            overflow-y: auto;
        }
        .stat-item {
            background: #fdfdfd; border: 1px solid #eee; border-radius: 6px;
            padding: 8px 12px; display: flex; flex-direction: column;
        }
        .stat-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .stat-label { font-size: 11px; color: #7f8c8d; font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 14px; font-weight: 700; color: #2c3e50; }
        
        .spark-wrapper { height: 30px; width: 100%; position: relative; border-bottom: 1px solid #eee; cursor: crosshair; }
        .spark-svg { width: 100%; height: 100%; overflow: hidden; pointer-events: none; }
        .spark-line { fill: none; stroke-width: 2; vector-effect: non-scaling-stroke; stroke-linecap: round; stroke-linejoin: round; }
        .spark-area { stroke: none; opacity: 0.1; }
        /* Chart Cursor */
        .chart-cursor { stroke: #555; stroke-width: 1px; stroke-dasharray: 2; opacity: 0; transition: opacity 0.1s; }
        .spark-wrapper:hover .chart-cursor { opacity: 1; }

        #global-tooltip {
            position: fixed; z-index: 9999;
            background: rgba(44, 62, 80, 0.95); color: white;
            padding: 10px; border-radius: 4px; font-size: 11px;
            pointer-events: none; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 240px; /* Widened for specs */
        }
        .spec-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed rgba(255,255,255,0.2); padding-bottom: 2px; }
        .spec-row span:first-child { color: #bdc3c7; }
        .highlight-row { color: var(--energy); font-weight: bold; border-top: 1px solid #666; padding-top: 5px; margin-top: 5px; }

        .log-wrapper {
            background: #2c3e50; display: flex; flex-direction: column; height: 100%; 
            border-top: 4px solid var(--primary); transition: all 0.3s; z-index: 500;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        }
        .log-header {
            background: #1a252f; color: #fff; padding: 5px 15px; height: 30px; 
            display: flex; justify-content: space-between; align-items: center; font-size: 12px; cursor: pointer;
        }
        .log-header:hover { background: #243342; }
        .log-tools { display: flex; gap: 10px; }
        .log-btn { background: none; border: none; color: #bdc3c7; cursor: pointer; font-size: 12px; padding: 2px 5px; }
        .log-btn:hover { color: #fff; background: rgba(255,255,255,0.1); border-radius: 3px; }
        .log-console { color: #ecf0f1; font-family: 'Consolas', monospace; font-size: 12px; padding: 10px 20px; overflow-y: auto; flex: 1; scroll-behavior: smooth; }
        .log-line { margin-bottom: 2px; opacity: 0.9; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-time { color: var(--energy); margin-right: 10px; font-weight: bold; }
        .log-info { color: #3498db; }
        .log-audit { color: #2ecc71; font-weight: bold; background: rgba(46, 204, 113, 0.1); padding: 5px; border-left: 3px solid #2ecc71; margin: 5px 0; }
        
        body.log-hidden .log-console { display: none; }
        body.log-hidden .log-btn.toggle i { transform: rotate(180deg); }

        @media (max-width: 1024px) {
            body { display: block; height: auto; min-height: 100vh; overflow-y: auto; }
            header { position: sticky; top: 0; width: 100%; height: 60px; padding: 0 10px; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); }
            .brand { font-size: 16px; }
            .brand span { display: none; }
            .sim-controls select { max-width: 80px; }
            .main-workspace { display: flex; flex-direction: column; padding: 10px; gap: 15px; height: auto; }
            .panel-box { height: auto; min-height: 250px; overflow: visible; }
            .field-wrapper { order: 1; height: 400px; min-height: 400px; }
            .panel-box:nth-child(3) { order: 2; height: 600px; }
            .panel-box:nth-child(1) { order: 3; }
            .log-wrapper { height: 300px; position: relative; margin-top: 20px; }
            #global-tooltip { width: 90%; left: 5% !important; margin-top: 20px; }
        }
    </style>
</head>
<body>
    <div id="global-tooltip"></div>

    <header>
        <div class="brand">
            <i class="fa-solid fa-wheat-awn" style="color:var(--success)"></i> Bristol Agri <span>Edition v3.0</span>
        </div>
        <div style="font-size: 14px; color: #555;">
            <i class="fa-regular fa-sun" id="sun-icon"></i> <span id="sim-clock">Day 1 - 06:00</span> <span style="margin-left:15px; font-weight:bold" id="sim-weather">Sunny</span>
        </div>
        <div class="sim-controls">
            <select id="speed-selector">
                <option value="1">1 min/s</option>
                <option value="5">5 min/s</option>
                <option value="10" selected>10 min/s</option>
                <option value="60">1 Hr/s (Ultra)</option>
            </select>
            <button onclick="sim.toggle()" id="btn-toggle" class="active"><i class="fa-solid fa-play"></i> Run</button>
            <button onclick="sim.reset()" class="stop"><i class="fa-solid fa-rotate-right"></i> Reset</button>
        </div>
    </header>

    <div class="main-workspace">
        <div class="panel-box">
            <div class="panel-header">System Parameters</div>
            <div class="settings-form">
                <div class="form-section" style="border-left: 3px solid var(--danger);">
                    <span class="section-title"><i class="fa-solid fa-flask"></i> Physics & Weather</span>
                    <div class="checkbox-row"><input type="checkbox" id="chk-overcast" onchange="sim.params.forceCloudy = this.checked"><label for="chk-overcast">Force Overcast</label></div>
                    <label class="form-label">Evaporation Rate: <span id="disp-evap">Normal</span></label>
                    <input type="range" min="1" max="5" value="2" step="1" oninput="sim.updatePhysicsParams(this.value, 'evap')">
                    <label class="form-label">Irrigation Speed: <span id="disp-flow">Normal</span></label>
                    <input type="range" min="1" max="5" value="2" step="1" oninput="sim.updatePhysicsParams(this.value, 'flow')">
                    <label class="form-label">Initial Moisture: <span id="disp-init">20-40</span>%</label>
                    <input type="range" min="10" max="80" value="20" step="10" oninput="sim.params.initMoistBase=parseInt(this.value); document.getElementById('disp-init').innerText = this.value + '-' + (parseInt(this.value)+20)">
                    <div style="font-size:10px; color:#e67e22;">*Requires Reset to apply</div>
                </div>

                <div class="form-section">
                    <span class="section-title"><i class="fa-solid fa-microchip"></i> Control Strategy</span>
                    <label class="form-label">Mode:</label>
                    <select id="mode-selector" style="width:100%" onchange="sim.updateControlMode(this.value)">
                        <option value="sensor" selected>Auto-Threshold (LoRa Logic)</option>
                        <option value="timer">Timer Schedule</option>
                    </select>
                    <div id="panel-timer" style="margin-top:10px; display:none; border-top:1px dashed #ddd; padding-top:8px;">
                        <label class="form-label">Start Time:</label>
                        <input type="time" id="timer-start" value="08:00" onchange="sim.params.timerStart=this.value" style="width:100%">
                        <label class="form-label" style="margin-top:5px">Duration (mins): <span id="disp-dur">30</span></label>
                        <input type="range" min="10" max="120" value="30" step="10" oninput="sim.params.timerDuration=parseInt(this.value); document.getElementById('disp-dur').innerText=this.value">
                    </div>
                </div>

                <div class="form-section">
                    <span class="section-title"><i class="fa-solid fa-solar-panel"></i> Solar Config</span>
                    <label class="form-label">Sunrise: <span id="disp-sunrise">06:00</span></label>
                    <input type="range" min="4" max="10" value="6" oninput="sim.params.sunrise=parseInt(this.value); document.getElementById('disp-sunrise').innerText=this.value.toString().padStart(2,'0')+':00'">
                    <label class="form-label">Sunset: <span id="disp-sunset">18:00</span></label>
                    <input type="range" min="16" max="21" value="18" oninput="sim.params.sunset=parseInt(this.value); document.getElementById('disp-sunset').innerText=this.value.toString().padStart(2,'0')+':00'">
                    <label class="form-label">Solar Intensity: <span id="disp-int">High</span></label>
                    <input type="range" min="500" max="1200" step="100" value="1000" oninput="sim.params.maxSun=parseInt(this.value); document.getElementById('disp-int').innerText=this.value + ' W/m²'">
                </div>

                <div class="form-section" id="section-lora">
                    <span class="section-title"><i class="fa-solid fa-rss"></i> LoRa Logic</span>
                    <label class="form-label">Moisture Lower Threshold (On): <span id="disp-trig">30</span>%</label>
                    <input type="range" min="10" max="50" value="30" oninput="sim.params.triggerMoist=parseInt(this.value); document.getElementById('disp-trig').innerText=this.value">
                    <label class="form-label">Moisture Upper Threshold (Off): <span id="disp-target">60</span>%</label>
                    <input type="range" min="40" max="90" value="60" oninput="sim.params.targetMoist=parseInt(this.value); document.getElementById('disp-target').innerText=this.value">
                </div>
            </div>
        </div>

        <div class="panel-box field-wrapper">
            <div class="panel-header" style="display:flex; justify-content:space-between">
                <span>Test Plot (5*5 m^2)</span>
                <span id="active-nodes" style="color:var(--primary)">Nozzles: 0/16</span>
            </div>
            <div class="farm-grid" id="farm-grid">
                </div>
        </div>

        <div class="panel-box">
            <div class="panel-header">System Components</div>
            <div class="topo-visual">
                <div class="comp-card" id="card-solar" onmousemove="sim.showCompTooltip(event, 'solar')" onmouseleave="sim.hideCompTooltip()">
                    <div class="comp-icon"><i class="fa-solid fa-solar-panel" style="color:var(--energy)"></i></div>
                    <div class="comp-info"><h4>PV Array</h4><p id="txt-solar">0 W | 0 V</p></div>
                    <div class="status-dot" id="dot-solar"></div>
                </div>
                <div class="comp-card" id="card-batt" onmousemove="sim.showCompTooltip(event, 'battery')" onmouseleave="sim.hideCompTooltip()">
                    <div class="comp-icon"><i class="fa-solid fa-car-battery" style="color:#2c3e50"></i></div>
                    <div class="comp-info"><h4>Battery</h4><p id="txt-batt">100%</p></div>
                    <div class="status-dot on"></div>
                </div>
                <div class="comp-card" id="card-pump" onmousemove="sim.showCompTooltip(event, 'pump')" onmouseleave="sim.hideCompTooltip()">
                    <div class="comp-icon"><i class="fa-solid fa-faucet-drip" style="color:var(--primary)"></i></div>
                    <div class="comp-info"><h4>Pump</h4><p id="txt-pump">OFF</p></div>
                    <div class="status-dot" id="dot-pump"></div>
                </div>
                <div class="comp-card" id="card-controller" onmousemove="sim.showCompTooltip(event, 'controller')" onmouseleave="sim.hideCompTooltip()">
                    <div class="comp-icon"><i class="fa-solid fa-microchip" style="color:var(--lora)"></i></div>
                    <div class="comp-info"><h4>Charge Controller</h4><p>Victron MPPT</p></div>
                    <div class="status-dot on"></div>
                </div>
                <div class="comp-card" style="display:block">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <div class="comp-icon" style="width:24px; height:24px;"><i class="fa-solid fa-tower-broadcast" style="color:var(--lora); font-size:12px"></i></div>
                        <div class="comp-info"><h4>Sensor Array Status</h4></div>
                    </div>
                    <table class="sensor-table">
                        <tr><td>Group 1 (NW)</td><td id="txt-s-0">0%</td></tr>
                        <tr><td>Group 2 (NE)</td><td id="txt-s-1">0%</td></tr>
                        <tr><td>Group 3 (SW)</td><td id="txt-s-2">0%</td></tr>
                        <tr><td>Group 4 (SE)</td><td id="txt-s-3">0%</td></tr>
                    </table>
                </div>
            </div>

            <div class="stats-divider"></div>

            <div class="panel-header" style="border:none; margin-bottom:5px;">Daily Statistics (7-Day Trend)</div>
            <div class="stats-container">
                <div class="stat-item" style="flex-direction:row; align-items:center; justify-content:space-between; padding:12px;">
                    <div>
                        <div class="stat-label">System Uptime</div>
                        <div class="stat-value" id="stat-days">0 Days</div>
                    </div>
                    <i class="fa-regular fa-clock" style="font-size:20px; color:#bdc3c7;"></i>
                </div>

                <div class="stat-item">
                    <div class="stat-meta">
                        <span class="stat-label" id="lbl-water">Last 24h Water</span>
                        <span class="stat-value" id="stat-water" style="color:var(--primary)">0 L</span>
                    </div>
                    <div class="spark-wrapper" onmousemove="sim.handleChartHover(event, 'water')" onmouseleave="sim.resetChartHover('water')">
                        <svg class="spark-svg" preserveAspectRatio="none" viewBox="0 0 100 100">
                            <path class="spark-area" id="spark-water-area" d="" fill="var(--primary)"></path>
                            <path class="spark-line" id="spark-water-line" d="" stroke="var(--primary)"></path>
                            <line id="cursor-line-water" class="chart-cursor" x1="0" y1="0" x2="0" y2="100"></line>
                        </svg>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-meta">
                        <span class="stat-label" id="lbl-out">Last 24h Energy Used</span>
                        <span class="stat-value" id="stat-eng-out" style="color:#e74c3c">0 Wh</span>
                    </div>
                    <div class="spark-wrapper" onmousemove="sim.handleChartHover(event, 'out')" onmouseleave="sim.resetChartHover('out')">
                        <svg class="spark-svg" preserveAspectRatio="none" viewBox="0 0 100 100">
                            <path class="spark-area" id="spark-out-area" d="" fill="#e74c3c"></path>
                            <path class="spark-line" id="spark-out-line" d="" stroke="#e74c3c"></path>
                            <line id="cursor-line-out" class="chart-cursor" x1="0" y1="0" x2="0" y2="100"></line>
                        </svg>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-meta">
                        <span class="stat-label" id="lbl-in">Last 24h Generation</span>
                        <span class="stat-value" id="stat-eng-in" style="color:var(--energy)">0 Wh</span>
                    </div>
                    <div class="spark-wrapper" onmousemove="sim.handleChartHover(event, 'in')" onmouseleave="sim.resetChartHover('in')">
                        <svg class="spark-svg" preserveAspectRatio="none" viewBox="0 0 100 100">
                            <path class="spark-area" id="spark-in-area" d="" fill="var(--energy)"></path>
                            <path class="spark-line" id="spark-in-line" d="" stroke="var(--energy)"></path>
                            <line id="cursor-line-in" class="chart-cursor" x1="0" y1="0" x2="0" y2="100"></line>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="log-wrapper">
        <div class="log-header" onclick="sim.toggleLogPanel()">
            <span><i class="fa-solid fa-terminal"></i> System Event Log</span>
            <div class="log-tools">
                <button class="log-btn" onclick="event.stopPropagation(); sim.clearLog()"><i class="fa-solid fa-trash"></i> Clear</button>
                <button class="log-btn toggle" id="log-toggle-btn"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
        </div>
        <div class="log-console" id="log-console">
            <div class="log-line"><span class="log-time">[06:00]</span>System Boot Sequence Initiated...</div>
            <div class="log-line"><span class="log-time">[06:00]</span>Components Loaded: Renogy PV, Victron MPPT, ESP32, R385 Pump.</div>
        </div>
    </div>

    <script>
        const COMPONENT_SPECS = {
            solar: { model: "Renogy 100W Monocrystalline", pmax: 100, v_mp: 19.97, eff: "20.0%", dim: "865x578x30mm" },
            battery: { model: "Advanced AGM LP100", cap: 100, v_nom: 12, type: "AGM", life: "500 Cycles" },
            pump: { model: "R385 DC Diaphragm", flow_rate: 1.75, p_rating: 7.2, v_op: "12V DC" }, 
            controller: { model: "Victron SmartSolar MPPT 75/10", max_current: "10A", eff: "98%" },
            mcu: { model: "ESP32 NodeMCU Dev Kit C V2", p_active: 1.0, p_sleep: 0.1, wifi: "802.11 b/g/n" },
            sensor: { model: "Capacitive Soil Moisture V1.2", v_op: "3.3-5V" }
        };

        class Simulation {
            constructor() {
                this.timer = null;
                this.isRunning = false;
                this.hoveredComp = null; 
                
                this.state = {
                    time: 6 * 60,
                    dayCount: 1, 
                    battAh: 100, battV: 12.8,
                    solarW: 0, pumpFlow: 0, 
                    activeGroups: 0, 
                    blocks: [], 
                    groups: [] 
                };
                
                this.dailyStats = { water: 0, energyIn: 0, energyOut: 0 };
                
                this.history = {
                    water: [0,0,0,0,0,0,0],
                    energyIn: [0,0,0,0,0,0,0],
                    energyOut: [0,0,0,0,0,0,0]
                };

                this.params = {
                    sunrise: 6, sunset: 18, maxSun: 1000,
                    controlMode: 'sensor', 
                    triggerMoist: 30, targetMoist: 60,
                    timerStart: "08:00", timerDuration: 30,
                    forceCloudy: false, evapFactor: 0.01, irrigFactor: 1.0, initMoistBase: 20
                };
                this.initNodes();
                this.updateControlMode('sensor');
            }

            updateControlMode(mode) {
                this.params.controlMode = mode;
                const timerPanel = document.getElementById('panel-timer');
                const loraSection = document.getElementById('section-lora');
                
                if (mode === 'timer') {
                    timerPanel.style.display = 'block';
                    loraSection.classList.add('disabled');
                } else {
                    timerPanel.style.display = 'none';
                    loraSection.classList.remove('disabled');
                }
                this.log(`Control Mode switched to: ${mode === 'sensor' ? 'Auto-Threshold' : 'Timer Schedule'}`);
            }

            initNodes() {
                const grid = document.getElementById('farm-grid');
                grid.innerHTML = '';
                this.state.blocks = [];
                this.state.groups = [];

                for(let g=0; g<4; g++) {
                    this.state.groups.push({ 
                        id: g, 
                        sensorVal: 0, 
                        isOpen: false,
                        lastIrrigTime: { day: 0, time: 0 } 
                    });
                }

                for(let i=0; i<16; i++) {
                    const row = Math.floor(i / 4);
                    const col = i % 4;
                    let groupId = 0;
                    if (row < 2 && col < 2) groupId = 0;
                    else if (row < 2 && col >= 2) groupId = 1;
                    else if (row >= 2 && col < 2) groupId = 2;
                    else groupId = 3;

                    const block = { id: i, groupId: groupId, moist: this.params.initMoistBase + Math.random() * 20 };
                    this.state.blocks.push(block);

                    const div = document.createElement('div');
                    div.className = `crop-unit`;
                    div.id = `block-${i}`;
                    div.innerHTML = `
                        <div class="nozzle"></div>
                        <div style="position:absolute; width:100%; height:100%; top:0; left:0" 
                             onmousemove="sim.showBlockTooltip(event, ${i})" 
                             onmouseleave="sim.hideNodeTooltip()"></div>
                    `;
                    grid.appendChild(div);
                }

                const coords = [
                    {top: '25%', left: '25%'}, {top: '25%', left: '75%'},
                    {top: '75%', left: '25%'}, {top: '75%', left: '75%'}
                ];
                coords.forEach((pos, idx) => {
                    const sens = document.createElement('div');
                    sens.className = 'sensor-overlay';
                    sens.id = `sensor-group-${idx}`;
                    sens.style.top = `calc(${pos.top} - 24px)`; 
                    sens.style.left = `calc(${pos.left} - 24px)`;
                    sens.innerHTML = `<i class="fa-solid fa-tower-broadcast"></i><span class="val">0%</span>`;
                    
                    sens.onclick = () => {
                        const grp = this.state.groups[idx];
                        const lossRate = (this.params.evapFactor * 60).toFixed(2); 
                        
                        let timeSince = "N/A";
                        if (grp.lastIrrigTime.day > 0) {
                            const currentTotalMins = (this.state.dayCount * 24 * 60) + this.state.time;
                            const lastTotalMins = (grp.lastIrrigTime.day * 24 * 60) + grp.lastIrrigTime.time;
                            const diff = currentTotalMins - lastTotalMins;
                            const h = Math.floor(diff/60);
                            const m = diff%60;
                            timeSince = `${h}h ${m}m`;
                        } else {
                            timeSince = "Never";
                        }
                        
                        sim.log(`[Sensor ${idx+1}] Loss Rate: -${lossRate}%/hr | Last Irrig: ${timeSince} ago`);
                    };
                    
                    grid.appendChild(sens);
                });
            }

            processOneMinute() {
                this.state.time += 1;
                
                if(this.state.time >= 24*60) {
                    this.state.time = 0; 
                    this.state.dayCount++;
                    
                    this.history.water.push(this.dailyStats.water);
                    this.history.water.shift();
                    this.history.energyIn.push(this.dailyStats.energyIn);
                    this.history.energyIn.shift();
                    this.history.energyOut.push(this.dailyStats.energyOut);
                    this.history.energyOut.shift();
                    
                    this.logAudit(`[Day Summary] Water: ${this.dailyStats.water.toFixed(1)}L | Gen: ${this.dailyStats.energyIn.toFixed(1)}Wh`);
                    this.dailyStats = { water: 0, energyIn: 0, energyOut: 0 };
                    this.updateStatsUI();
                }

                const hour = this.state.time / 60;

                let irradiance = 0;
                if (!this.params.forceCloudy && hour > this.params.sunrise && hour < this.params.sunset) {
                    const dayLen = this.params.sunset - this.params.sunrise;
                    const progress = (hour - this.params.sunrise) / dayLen;
                    irradiance = Math.sin(progress * Math.PI) * this.params.maxSun;
                    irradiance = Math.max(0, irradiance);
                }
                this.state.solarW = (irradiance / 1000) * COMPONENT_SPECS.solar.pmax;

                this.state.groups.forEach(group => {
                    const blocksInGroup = this.state.blocks.filter(b => b.groupId === group.id);
                    const avgMoist = blocksInGroup.reduce((sum, b) => sum + b.moist, 0) / blocksInGroup.length;
                    group.sensorVal = avgMoist;
                });

                this.state.activeGroups = 0;
                const getMins = (str) => { const parts = str.split(':'); return parseInt(parts[0])*60 + parseInt(parts[1]); };

                this.state.groups.forEach(group => {
                    let shouldIrrigate = false;
                    const wasOpen = group.isOpen;

                    if (this.params.controlMode === 'sensor') {
                        if (group.sensorVal < this.params.triggerMoist) group.isOpen = true;
                        if (group.sensorVal >= this.params.targetMoist) group.isOpen = false;
                        shouldIrrigate = group.isOpen;
                    } else {
                        const startMins = getMins(this.params.timerStart);
                        const endMins = startMins + this.params.timerDuration;
                        if (this.state.time >= startMins && this.state.time < endMins) shouldIrrigate = true;
                        else shouldIrrigate = false;
                        group.isOpen = shouldIrrigate;
                    }

                    if (!wasOpen && shouldIrrigate) {
                        group.lastIrrigTime = { day: this.state.dayCount, time: this.state.time };
                    }

                    if (shouldIrrigate) this.state.activeGroups++;
                });

                this.state.blocks.forEach(block => {
                    const baseEvap = (irradiance > 100) ? this.params.evapFactor : (this.params.evapFactor * 0.25); 
                    block.moist -= baseEvap;
                    if (this.state.groups[block.groupId].isOpen) block.moist += this.params.irrigFactor;
                    block.moist = Math.max(0, Math.min(100, block.moist));
                });

                const isPumpOn = this.state.activeGroups > 0;
                
                let currentLoadW = 0;
                let currentChargeW = this.state.solarW;

                if (isPumpOn) {
                    this.state.pumpFlow = COMPONENT_SPECS.pump.flow_rate; 
                    currentLoadW = COMPONENT_SPECS.pump.p_rating + COMPONENT_SPECS.mcu.p_active;
                } else {
                    this.state.pumpFlow = 0;
                    currentLoadW = COMPONENT_SPECS.mcu.p_active * 0.5; 
                }

                const drainAh = (currentLoadW / 12) * (1/60);
                const chargeAh = (currentChargeW / 14) * (1/60);
                this.state.battAh = Math.max(0, Math.min(100, this.state.battAh - drainAh + chargeAh));
                this.state.battV = 11.5 + (this.state.battAh/100)*1.8 + (this.state.solarW>0 ? 0.5 : 0);

                const eIn = currentChargeW * (1/60);
                const eOut = currentLoadW * (1/60);
                this.dailyStats.water += this.state.pumpFlow;
                this.dailyStats.energyIn += eIn;
                this.dailyStats.energyOut += eOut;
            }

            handleChartHover(e, type) {
                const wrapper = e.currentTarget;
                const rect = wrapper.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                
                const dataLen = this.history.water.length; // 7 days
                const idx = Math.min(dataLen - 1, Math.max(0, Math.floor((x / width) * dataLen)));
                
                let val = 0;
                let unit = '';
                if(type === 'water') { val = this.history.water[idx]; unit='L'; }
                else if(type === 'out') { val = this.history.energyOut[idx]; unit='Wh'; }
                else if(type === 'in') { val = this.history.energyIn[idx]; unit='Wh'; }

                const cursor = document.getElementById(`cursor-line-${type}`);
                const xPos = (idx / (dataLen - 1)) * 100;
                cursor.setAttribute('x1', xPos);
                cursor.setAttribute('x2', xPos);

                const label = document.getElementById(type === 'water' ? 'lbl-water' : (type === 'out' ? 'lbl-out' : 'lbl-in'));
                const valueEl = document.getElementById(type === 'water' ? 'stat-water' : (type === 'out' ? 'stat-eng-out' : 'stat-eng-in'));
                
                const daysAgo = (dataLen - 1) - idx;
                label.innerText = daysAgo === 0 ? "Today (Live)" : `${daysAgo} Days Ago`;
                label.style.color = "var(--primary)";
                valueEl.innerText = `${val.toFixed(1)} ${unit}`;
            }

            resetChartHover(type) {
                const label = document.getElementById(type === 'water' ? 'lbl-water' : (type === 'out' ? 'lbl-out' : 'lbl-in'));
                const valueEl = document.getElementById(type === 'water' ? 'stat-water' : (type === 'out' ? 'stat-eng-out' : 'stat-eng-in'));
                
                label.innerText = type === 'water' ? 'Last 24h Water' : (type === 'out' ? 'Last 24h Energy Used' : 'Last 24h Generation');
                label.style.color = "#7f8c8d";
                
                if(type === 'water') valueEl.innerText = `${this.dailyStats.water.toFixed(1)} L`;
                else if(type === 'out') valueEl.innerText = `${this.dailyStats.energyOut.toFixed(1)} Wh`;
                else if(type === 'in') valueEl.innerText = `${this.dailyStats.energyIn.toFixed(1)} Wh`;
            }

            updateUI(irradiance) {
                const h = Math.floor(this.state.time / 60);
                const m = this.state.time % 60;
                document.getElementById('sim-clock').innerText = `Day ${this.state.dayCount} - ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                
                if (this.params.forceCloudy) {
                    document.getElementById('sim-weather').innerText = "Overcast";
                    document.getElementById('sun-icon').className = "fa-solid fa-cloud";
                } else if (irradiance > 100) {
                    document.getElementById('sim-weather').innerText = "Sunny";
                    document.getElementById('sun-icon').className = "fa-solid fa-sun";
                } else {
                    document.getElementById('sim-weather').innerText = "Night";
                    document.getElementById('sun-icon').className = "fa-solid fa-moon";
                }

                document.getElementById('txt-solar').innerText = `${this.state.solarW.toFixed(0)} W | ${irradiance.toFixed(0)} W/m²`;
                document.getElementById('dot-solar').className = `status-dot ${this.state.solarW > 5 ? 'on' : ''}`;
                document.getElementById('txt-batt').innerText = `${this.state.battAh.toFixed(1)}%`;
                
                const isPumping = this.state.activeGroups > 0;
                document.getElementById('txt-pump').innerText = isPumping ? `ON | ${this.state.pumpFlow.toFixed(1)} L/m` : "OFF";
                document.getElementById('dot-pump').className = `status-dot ${isPumping ? 'on' : ''}`;
                document.getElementById('active-nodes').innerText = `Active Nozzles: ${this.state.activeGroups * 4}/16`;

                if (!document.querySelector('.spark-wrapper:hover')) {
                    this.updateStatsUI();
                }

                this.state.blocks.forEach(block => {
                    const el = document.getElementById(`block-${block.id}`);
                    const opacity = Math.max(0.1, block.moist / 100); 
                    el.style.backgroundColor = `rgba(52, 152, 219, ${opacity})`;
                    const isWatering = this.state.groups[block.groupId].isOpen;
                    if(isWatering) el.classList.add('watering');
                    else el.classList.remove('watering');
                });

                this.state.groups.forEach((g, idx) => {
                    const el = document.getElementById(`sensor-group-${idx}`);
                    el.querySelector('.val').innerText = `${g.sensorVal.toFixed(1)}%`;
                    document.getElementById(`txt-s-${idx}`).innerText = `${g.sensorVal.toFixed(1)}%`;
                    document.getElementById(`txt-s-${idx}`).style.color = g.isOpen ? 'var(--primary)' : 'var(--text-main)';
                });

                if (this.hoveredComp) this.updateTooltipContent(this.hoveredComp);
            }

            updateStatsUI() {
                document.getElementById('stat-days').innerText = `${this.state.dayCount} Days`;
                document.getElementById('stat-water').innerText = `${(this.dailyStats.water).toFixed(1)} L`;
                document.getElementById('stat-eng-out').innerText = `${(this.dailyStats.energyOut).toFixed(1)} Wh`;
                document.getElementById('stat-eng-in').innerText = `${(this.dailyStats.energyIn).toFixed(1)} Wh`;

                const draw = (idPrefix, data) => {
                    const paths = this.getSparklineSVG(data);
                    document.getElementById(`${idPrefix}-line`).setAttribute('d', paths.line);
                    document.getElementById(`${idPrefix}-area`).setAttribute('d', paths.area);
                };
                draw('spark-water', this.history.water);
                draw('spark-out', this.history.energyOut);
                draw('spark-in', this.history.energyIn);
            }

            toggle() {
                const btn = document.getElementById('btn-toggle');
                if(this.isRunning) {
                    clearInterval(this.timer);
                    this.isRunning = false;
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Run';
                    btn.classList.remove('stop');
                    this.log("System Paused.");
                } else {
                    this.timer = setInterval(() => this.tick(), 1000); 
                    this.isRunning = true;
                    btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
                    btn.classList.add('stop');
                    this.log("System Running.");
                }
            }

            reset() {
                clearInterval(this.timer);
                this.isRunning = false;
                this.state.time = 6 * 60;
                this.state.dayCount = 1;
                this.state.battAh = 100;
                this.dailyStats = { water: 0, energyIn: 0, energyOut: 0 };
                this.history = { water: [0,0,0,0,0,0,0], energyIn: [0,0,0,0,0,0,0], energyOut: [0,0,0,0,0,0,0] };
                this.initNodes();
                this.updateUI(0); 
                document.getElementById('btn-toggle').innerHTML = '<i class="fa-solid fa-play"></i> Run';
                document.getElementById('btn-toggle').classList.remove('stop');
                this.clearLog(); 
                this.log("System Reset Complete.");
            }

            tick() {
                const speed = parseInt(document.getElementById('speed-selector').value); 
                for(let i=0; i<speed; i++) {
                    this.processOneMinute();
                }
                const hour = this.state.time / 60;
                let uiIrradiance = 0;
                if (!this.params.forceCloudy && hour > this.params.sunrise && hour < this.params.sunset) {
                     const dayLen = this.params.sunset - this.params.sunrise;
                     const progress = (hour - this.params.sunrise) / dayLen;
                     uiIrradiance = Math.sin(progress * Math.PI) * this.params.maxSun;
                }
                this.updateUI(uiIrradiance);
            }

            getSparklineSVG(data) {
                if (!data || data.length === 0) return { line: "", area: "" };
                const max = Math.max(...data, 1);
                const points = data.map((val, i) => {
                    const x = (i / (data.length - 1)) * 100;
                    const y = 100 - (val / max) * 90; 
                    return {x, y};
                });
                let d = `M ${points[0].x} ${points[0].y}`;
                for(let i=1; i<points.length; i++) d += ` L ${points[i].x} ${points[i].y}`;
                const areaD = `${d} L 100 100 L 0 100 Z`;
                return { line: d, area: areaD };
            }

            log(msg) {
                const box = document.getElementById('log-console');
                const h = Math.floor(this.state.time / 60);
                const m = this.state.time % 60;
                const timeStr = `[${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}]`;
                const line = document.createElement('div');
                line.className = 'log-line';
                line.innerHTML = `<span class="log-time">${timeStr}</span> ${msg}`;
                box.appendChild(line);
                box.scrollTop = box.scrollHeight;
                if(box.children.length > 200) box.removeChild(box.firstChild);
            }

            logAudit(msg) {
                const box = document.getElementById('log-console');
                const line = document.createElement('div');
                line.className = 'log-audit';
                line.innerText = msg;
                box.appendChild(line);
                box.scrollTop = box.scrollHeight;
            }

            showCompTooltip(e, type) {
                this.hoveredComp = type;
                this.updateTooltipContent(type); 
                const tt = document.getElementById('global-tooltip');
                tt.style.display = 'block';
                this.posTooltip(e, tt);
            }

            updateTooltipContent(type) {
                const tt = document.getElementById('global-tooltip');
                let html = '';
                if(type === 'pump') {
                    html = `<div class="spec-row highlight-row"><span>Flow:</span><span>${this.state.pumpFlow.toFixed(1)} L/m</span></div>
                            <div class="spec-row"><span>Model:</span><span>${COMPONENT_SPECS.pump.model}</span></div>
                            <div class="spec-row"><span>Power:</span><span>${COMPONENT_SPECS.pump.p_rating}W (${COMPONENT_SPECS.pump.v_op})</span></div>`;
                }
                else if(type === 'solar') {
                    html = `<div class="spec-row highlight-row"><span>Output:</span><span>${this.state.solarW.toFixed(1)} W</span></div>
                            <div class="spec-row"><span>Model:</span><span>${COMPONENT_SPECS.solar.model}</span></div>
                            <div class="spec-row"><span>P-Max:</span><span>${COMPONENT_SPECS.solar.pmax}W (Eff: ${COMPONENT_SPECS.solar.eff})</span></div>
                            <div class="spec-row"><span>V-MP:</span><span>${COMPONENT_SPECS.solar.v_mp}V</span></div>`;
                }
                else if(type === 'battery') {
                    html = `<div class="spec-row highlight-row"><span>SOC:</span><span>${this.state.battAh.toFixed(1)}%</span></div>
                            <div class="spec-row"><span>Model:</span><span>${COMPONENT_SPECS.battery.model}</span></div>
                            <div class="spec-row"><span>Cap:</span><span>${COMPONENT_SPECS.battery.cap}Ah (${COMPONENT_SPECS.battery.type})</span></div>
                            <div class="spec-row"><span>Cycle Life:</span><span>${COMPONENT_SPECS.battery.life}</span></div>`;
                }
                else if(type === 'controller') {
                    html = `<div class="spec-row"><span>Model:</span><span>${COMPONENT_SPECS.controller.model}</span></div>
                            <div class="spec-row"><span>Rating:</span><span>${COMPONENT_SPECS.controller.max_current}</span></div>
                            <div class="spec-row"><span>Efficiency:</span><span>${COMPONENT_SPECS.controller.eff}</span></div>`;
                }
                tt.innerHTML = html;
            }

            showBlockTooltip(e, id) {
                const tt = document.getElementById('global-tooltip');
                const block = this.state.blocks[id];
                const group = this.state.groups[block.groupId];
                tt.style.display = 'block';
                this.posTooltip(e, tt);
                const html = `
                    <div class="spec-row"><span>Block:</span><span>#${id}</span></div>
                    <div class="spec-row highlight-row"><span>Moist:</span><span>${block.moist.toFixed(1)}%</span></div>
                    <div class="spec-row"><span>Group Avg:</span><span>${group.sensorVal.toFixed(1)}%</span></div>
                    <div class="spec-row"><span>Sensor:</span><span>${COMPONENT_SPECS.sensor.model}</span></div>
                `;
                tt.innerHTML = html;
            }

            posTooltip(e, tt) {
                if(window.innerWidth < 1024) { tt.style.left = '5%'; tt.style.top = (e.clientY + 20) + 'px'; } 
                else { tt.style.left = (e.clientX + 15) + 'px'; tt.style.top = (e.clientY + 15) + 'px'; }
            }

            hideCompTooltip() { this.hoveredComp = null; document.getElementById('global-tooltip').style.display = 'none'; }
            hideNodeTooltip() { document.getElementById('global-tooltip').style.display = 'none'; }
            toggleLogPanel() { document.body.classList.toggle('log-hidden'); }
            clearLog() { document.getElementById('log-console').innerHTML = ''; }
            updatePhysicsParams(val, type) {
                if(type === 'evap') {
                    this.params.evapFactor = val * 0.01;
                    const labels = ["Very Slow", "Slow", "Normal", "Fast", "Extreme"];
                    document.getElementById('disp-evap').innerText = labels[val-1];
                } else if (type === 'flow') {
                    this.params.irrigFactor = val * 0.25;
                    const labels = ["Trickle", "Slow", "Normal", "Fast", "Surge"];
                    document.getElementById('disp-flow').innerText = labels[val-1];
                }
            }
        }

        const sim = new Simulation();
    </script>
</body>
</html>