<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart LoRa Irrigation Digital Twin v2.8 (Mobile Ready)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --primary: #3498db;
            --energy: #f1c40f;
            --lora: #9b59b6;
            --danger: #e74c3c;
            --success: #2ecc71;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --border: 1px solid #e1e4e8;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
            --log-height: 160px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* --- 桌面端基础布局 (保持原逻辑) --- */
        body {
            font-family: 'Segoe UI', 'Roboto', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden; 
            display: grid;
            grid-template-rows: 60px 1fr var(--log-height);
            transition: grid-template-rows 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body.log-hidden { grid-template-rows: 60px 1fr 30px; }

        /* --- Header --- */
        header {
            background: var(--panel-bg);
            border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-shadow: var(--shadow); z-index: 100;
        }

        .brand { font-size: 20px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--lora); background: rgba(155, 89, 182, 0.1); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .sim-controls { display: flex; gap: 15px; align-items: center; }
        select, button {
            background: #f8f9fa; border: 1px solid #ced4da; color: var(--text-main);
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-family: inherit; transition: all 0.2s;
        }
        button:hover { background: #e9ecef; }
        button.active { background: var(--success); color: white; border-color: var(--success); }
        button.stop { background: var(--danger); color: white; border-color: var(--danger); }

        /* --- Main Layout --- */
        .main-workspace {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 20px; padding: 20px;
            min-height: 0; height: 100%; overflow: hidden; z-index: 1;
        }

        .panel-box {
            background: var(--panel-bg); border-radius: 8px; border: var(--border);
            box-shadow: var(--shadow); padding: 15px; display: flex; flex-direction: column;
            position: relative; overflow: hidden; height: 100%;
        }
        .panel-header { font-size: 14px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; flex-shrink: 0; }

        /* --- Settings Panel --- */
        .settings-form { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; flex: 1; }
        .form-section { background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; flex-shrink: 0; }
        .section-title { font-size: 12px; font-weight: 700; color: var(--primary); margin-bottom: 8px; display: block; border-bottom: 1px dashed #ddd; padding-bottom: 4px;}
        .form-label { font-size: 12px; color: var(--text-main); margin-bottom: 4px; display: flex; justify-content: space-between; }
        input[type="range"] { width: 100%; accent-color: var(--primary); cursor: pointer; }
        input[type="checkbox"] { accent-color: var(--danger); transform: scale(1.2); cursor: pointer; }

        /* --- Farm Grid --- */
        .field-wrapper { overflow-y: auto; }
        .farm-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            width: 100%; height: 100%; 
            background: #e8dcc6; border: 8px solid #d4c5a9;
            padding: 10px; border-radius: 4px; position: relative; box-sizing: border-box;
        }
        .farm-grid::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(#bdc3c7 1px, transparent 1px), linear-gradient(90deg, #bdc3c7 1px, transparent 1px);
            background-size: 16.66% 16.66%; background-position: center;
            z-index: 0; pointer-events: none; opacity: 0.5;
        }
        .crop-unit {
            background: rgba(255,255,255,0.8); border: 1px solid #ccc; border-radius: 4px;
            position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.3s; cursor: pointer;
        }
        .crop-unit:hover { transform: scale(1.05); border-color: var(--lora); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; }
        .lora-ant { position: absolute; top: 2px; left: 2px; font-size: 10px; color: #ccc; }
        .crop-unit.active .lora-ant { color: var(--lora); animation: pulse 1s infinite; }
        .nozzle { width: 8px; height: 8px; background: #95a5a6; border-radius: 50%; margin-bottom: 5px; }
        .crop-unit.watering .nozzle { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
        .crop-unit.watering { background: #e1f5fe; border-color: var(--primary); }
        .moist-bar { width: 80%; height: 4px; background: #eee; border-radius: 2px; overflow: hidden; }
        .moist-val { height: 100%; background: var(--success); transition: width 0.5s; }

        /* --- Topo Visual --- */
        .topo-visual {
            flex: 1; display: flex; flex-direction: column; gap: 10px; align-items: center; justify-content: flex-start;
            padding: 10px; background: #fafafa; border-radius: 6px; overflow-y: auto;
        }
        .comp-card {
            width: 100%; background: white; border: 1px solid #eee; padding: 10px; border-radius: 6px;
            display: flex; align-items: center; gap: 10px; cursor: help; transition: all 0.2s; position: relative;
            flex-shrink: 0;
        }
        .comp-card:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .comp-icon { width: 40px; height: 40px; background: #f1f2f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #555; }
        .comp-info h4 { margin: 0; font-size: 13px; color: var(--text-main); }
        .comp-info p { margin: 2px 0 0; font-size: 11px; color: var(--text-sub); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-left: auto; }
        .status-dot.on { background: var(--success); box-shadow: 0 0 5px var(--success); }

        /* --- Tooltip (Global) --- */
        #global-tooltip {
            position: fixed; z-index: 9999;
            background: rgba(44, 62, 80, 0.95); color: white;
            padding: 10px; border-radius: 4px; font-size: 11px;
            pointer-events: none; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 200px;
        }
        .spec-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed rgba(255,255,255,0.2); padding-bottom: 2px; }
        .spec-row span:first-child { color: #bdc3c7; }
        .highlight-row { color: var(--energy); font-weight: bold; border-top: 1px solid #666; padding-top: 5px; margin-top: 5px; }

        /* --- Log Panel --- */
        .log-wrapper {
            background: #2c3e50; display: flex; flex-direction: column; height: 100%; 
            border-top: 4px solid var(--primary); transition: all 0.3s; z-index: 500;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        }
        .log-header {
            background: #1a252f; color: #fff; padding: 5px 15px; height: 30px; 
            display: flex; justify-content: space-between; align-items: center; font-size: 12px; cursor: pointer;
        }
        .log-header:hover { background: #243342; }
        .log-tools { display: flex; gap: 10px; }
        .log-btn { background: none; border: none; color: #bdc3c7; cursor: pointer; font-size: 12px; padding: 2px 5px; }
        .log-btn:hover { color: #fff; background: rgba(255,255,255,0.1); border-radius: 3px; }
        .log-console { color: #ecf0f1; font-family: 'Consolas', monospace; font-size: 12px; padding: 10px 20px; overflow-y: auto; flex: 1; scroll-behavior: smooth; }
        .log-line { margin-bottom: 2px; opacity: 0.9; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-time { color: var(--energy); margin-right: 10px; font-weight: bold; }
        .log-info { color: #3498db; }
        .log-audit { color: #2ecc71; font-weight: bold; background: rgba(46, 204, 113, 0.1); padding: 5px; border-left: 3px solid #2ecc71; margin: 5px 0; }
        
        body.log-hidden .log-console { display: none; }
        body.log-hidden .log-btn.toggle i { transform: rotate(180deg); }

        @keyframes pulse { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.5; transform: scale(1); } }

        /* ========================================= */
        /* --- 移动端响应式核心优化 (Mobile CSS) --- */
        /* ========================================= */
        @media (max-width: 1024px) {
            /* 1. 全局布局改为流式，允许滚动 */
            body {
                display: block; /* 取消 Grid，允许自然堆叠 */
                height: auto;
                min-height: 100vh;
                overflow-y: auto; /* 开启 Body 滚动 */
            }

            /* 2. Header 保持吸顶 */
            header {
                position: sticky; top: 0; width: 100%;
                height: 60px; padding: 0 10px;
                background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
            }
            .brand { font-size: 16px; }
            .brand span { display: none; /* 隐藏版本号省空间 */ }
            .sim-controls select { max-width: 80px; }

            /* 3. 主工作区垂直排列 */
            .main-workspace {
                display: flex; flex-direction: column;
                padding: 10px; gap: 15px; height: auto;
            }

            /* 4. 面板通用样式调整 */
            .panel-box {
                height: auto; min-height: 250px;
                overflow: visible; /* 允许内容撑开 */
            }

            /* 5. 核心排序：试验田置顶 */
            .field-wrapper {
                order: 1; 
                height: 400px; /* 给试验田固定高度，保证正方形显示 */
                min-height: 400px;
            }

            /* 组件卡片区 */
            .panel-box:nth-child(3) { /* System Components */
                order: 2;
                max-height: 400px;
            }

            /* 设置区放最后 */
            .panel-box:nth-child(1) { /* Settings */
                order: 3;
            }

            /* 6. 日志区作为页脚 */
            .log-wrapper {
                height: 300px; /* 固定高度 */
                position: relative;
                margin-top: 20px;
            }

            /* 7. 手机端 Tooltip 位置修正 */
            #global-tooltip {
                width: 90%; left: 5% !important;
                margin-top: 20px; /* 避免手指遮挡 */
            }
        }
    </style>
</head>
<body>
    <div id="global-tooltip"></div>

    <header>
        <div class="brand">
            <i class="fa-solid fa-wheat-awn" style="color:var(--success)"></i> AgriTech Pro <span>LoRaWAN Edition v2.8</span>
        </div>
        <div style="font-size: 14px; color: #555;">
            <i class="fa-regular fa-sun" id="sun-icon"></i> <span id="sim-clock">Day 0 - 06:00</span> <span style="margin-left:15px; font-weight:bold" id="sim-weather">Sunny</span>
        </div>
        <div class="sim-controls">
            <select id="speed-selector">
                <option value="1">1 min/s</option>
                <option value="5">5 min/s</option>
                <option value="10" selected>10 min/s</option>
                <option value="60">1 Hr/s (Ultra)</option>
            </select>
            <button onclick="sim.toggle()" id="btn-toggle" class="active"><i class="fa-solid fa-play"></i> Run</button>
            <button onclick="sim.reset()" class="stop"><i class="fa-solid fa-rotate-right"></i> Reset</button>
        </div>
    </header>

    <div class="main-workspace">
        <div class="panel-box">
            <div class="panel-header">System Parameters</div>
            <div class="settings-form">
                <div class="form-section" style="border-left: 3px solid var(--danger);">
                    <span class="section-title"><i class="fa-solid fa-flask"></i> Physics & Weather</span>
                    <div class="checkbox-row"><input type="checkbox" id="chk-overcast" onchange="sim.params.forceCloudy = this.checked"><label for="chk-overcast">Force Overcast</label></div>
                    <label class="form-label">Evaporation Rate: <span id="disp-evap">Normal</span></label>
                    <input type="range" min="1" max="5" value="2" step="1" oninput="sim.updatePhysicsParams(this.value, 'evap')">
                    <label class="form-label">Irrigation Speed: <span id="disp-flow">Normal</span></label>
                    <input type="range" min="1" max="5" value="2" step="1" oninput="sim.updatePhysicsParams(this.value, 'flow')">
                    <label class="form-label">Initial Moisture: <span id="disp-init">30-50</span>%</label>
                    <input type="range" min="10" max="80" value="30" step="10" oninput="sim.params.initMoistBase=parseInt(this.value); document.getElementById('disp-init').innerText = this.value + '-' + (parseInt(this.value)+20)">
                    <div style="font-size:10px; color:#e67e22;">*Requires Reset to apply</div>
                </div>
                <div class="form-section">
                    <span class="section-title"><i class="fa-solid fa-solar-panel"></i> Solar Config</span>
                    <label class="form-label">Sunrise: <span id="disp-sunrise">06:00</span></label>
                    <input type="range" min="4" max="9" value="6" oninput="sim.params.sunrise=parseInt(this.value); document.getElementById('disp-sunrise').innerText=this.value.toString().padStart(2,'0')+':00'">
                    <label class="form-label">Sunset: <span id="disp-sunset">19:00</span></label>
                    <input type="range" min="16" max="21" value="19" oninput="sim.params.sunset=parseInt(this.value); document.getElementById('disp-sunset').innerText=this.value.toString().padStart(2,'0')+':00'">
                </div>
                <div class="form-section">
                    <span class="section-title"><i class="fa-solid fa-rss"></i> LoRa Logic</span>
                    <label class="form-label">Trigger Moist: <span id="disp-trig">40</span>%</label>
                    <input type="range" min="20" max="60" value="40" oninput="sim.params.triggerMoist=parseInt(this.value); document.getElementById('disp-trig').innerText=this.value">
                    <label class="form-label">Target Moist: <span id="disp-target">70</span>%</label>
                    <input type="range" min="60" max="90" value="70" oninput="sim.params.targetMoist=parseInt(this.value); document.getElementById('disp-target').innerText=this.value">
                </div>
            </div>
        </div>

        <div class="panel-box field-wrapper">
            <div class="panel-header" style="display:flex; justify-content:space-between">
                <span>Test Plot (6x6 LoRa Nodes)</span>
                <span id="active-nodes" style="color:var(--primary)">Active: 0/36</span>
            </div>
            <div class="farm-grid" id="farm-grid"></div>
        </div>

        <div class="panel-box">
            <div class="panel-header">System Components</div>
            <div class="topo-visual">
                <div class="comp-card" id="card-solar" onmousemove="sim.showCompTooltip(event, 'solar')" onmouseleave="sim.hideCompTooltip()">
                    <div class="comp-icon"><i class="fa-solid fa-solar-panel" style="color:var(--energy)"></i></div>
                    <div class="comp-info"><h4>PV Array</h4><p id="txt-solar">0 W | 0 V</p></div>
                    <div class="status-dot" id="dot-solar"></div>
                </div>
                <div class="comp-card" id="card-batt" onmousemove="sim.showCompTooltip(event, 'battery')" onmouseleave="sim.hideCompTooltip()">
                    <div class="comp-icon"><i class="fa-solid fa-car-battery" style="color:#2c3e50"></i></div>
                    <div class="comp-info"><h4>Main Battery</h4><p id="txt-batt">100% | 12.8V</p></div>
                    <div class="status-dot on"></div>
                </div>
                <div class="comp-card" id="card-pump" onmousemove="sim.showCompTooltip(event, 'pump')" onmouseleave="sim.hideCompTooltip()">
                    <div class="comp-icon"><i class="fa-solid fa-faucet-drip" style="color:var(--primary)"></i></div>
                    <div class="comp-info"><h4>Main Pump</h4><p id="txt-pump">OFF | 0 L/min</p></div>
                    <div class="status-dot" id="dot-pump"></div>
                </div>
                <div class="comp-card" id="card-gateway" onmousemove="sim.showCompTooltip(event, 'gateway')" onmouseleave="sim.hideCompTooltip()">
                    <div class="comp-icon"><i class="fa-solid fa-wifi" style="color:var(--lora)"></i></div>
                    <div class="comp-info"><h4>LoRa Gateway</h4><p>Listening...</p></div>
                    <div class="status-dot on"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="log-wrapper">
        <div class="log-header" onclick="sim.toggleLogPanel()">
            <span><i class="fa-solid fa-terminal"></i> System Event Log</span>
            <div class="log-tools">
                <button class="log-btn" onclick="event.stopPropagation(); sim.clearLog()"><i class="fa-solid fa-trash"></i> Clear</button>
                <button class="log-btn toggle" id="log-toggle-btn"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
        </div>
        <div class="log-console" id="log-console">
            <div class="log-line"><span class="log-time">[06:00]</span>System Boot Sequence Initiated...</div>
            <div class="log-line"><span class="log-time">[06:00]</span>LoRa Gateway Connected. 36 Nodes found.</div>
        </div>
    </div>

    <script>
        const COMPONENT_SPECS = {
            solar: { model: "Renogy-100W", pmax: 100, eff: 0.21 },
            battery: { model: "Loch-AGM-100", cap: 100, v_nom: 12 },
            pump: { model: "R385-Diaphragm", flow_max: 2.0, p_rate: 10 }, 
            node: { model: "LoRa-Node-V1", p_idle: 0.05, p_active: 2.5 }
        };

        class Simulation {
            constructor() {
                this.timer = null;
                this.isRunning = false;
                this.hoveredComp = null; 
                
                this.state = {
                    time: 6 * 60,
                    battAh: 100, battV: 12.8,
                    solarW: 0, pumpFlow: 0, activeValves: 0, 
                    zones: [] 
                };
                this.hourlyStats = { waterL: 0, energyInWh: 0, energyOutWh: 0 };
                this.lastHourAvgConsumptionW = 0; 
                this.params = {
                    sunrise: 6, sunset: 19, maxSun: 1000,
                    triggerMoist: 40, targetMoist: 70,
                    forceCloudy: false, evapFactor: 0.02, irrigFactor: 0.5, initMoistBase: 30
                };
                this.initNodes();
            }

            showCompTooltip(e, type) {
                this.hoveredComp = type;
                this.updateTooltipContent(type); 
                const tt = document.getElementById('global-tooltip');
                tt.style.display = 'block';
                // 触摸设备位置修正
                if(window.innerWidth < 1024) {
                    tt.style.left = '5%';
                    tt.style.top = (e.clientY + 20) + 'px';
                } else {
                    tt.style.left = (e.clientX + 15) + 'px';
                    tt.style.top = (e.clientY + 15) + 'px';
                }
            }

            hideCompTooltip() {
                this.hoveredComp = null;
                document.getElementById('global-tooltip').style.display = 'none';
            }

            updateTooltipContent(type) {
                const tt = document.getElementById('global-tooltip');
                let html = '';
                const h = this.state.time / 60;
                let irradiance = 0;
                if (!this.params.forceCloudy && h > this.params.sunrise && h < this.params.sunset) {
                    const progress = (h - this.params.sunrise) / (this.params.sunset - this.params.sunrise);
                    irradiance = Math.sin(progress * Math.PI) * this.params.maxSun;
                    irradiance = Math.max(0, irradiance);
                }

                if (type === 'solar') {
                    const autonomy = this.calculateAutonomy();
                    html = `<div class="spec-row"><span>Model:</span><span>${COMPONENT_SPECS.solar.model}</span></div><div class="spec-row"><span>Rating:</span><span>${COMPONENT_SPECS.solar.pmax} Wp</span></div><div class="spec-row"><span>Output:</span><span>${this.state.solarW.toFixed(1)} W</span></div><div class="spec-row"><span>Irrad:</span><span>${irradiance.toFixed(0)} W/m²</span></div><div class="spec-row highlight-row"><span>Est. Runtime:</span><span>${autonomy}</span></div>`;
                } else if (type === 'battery') {
                    const autonomy = this.calculateAutonomy();
                    html = `<div class="spec-row"><span>Model:</span><span>${COMPONENT_SPECS.battery.model}</span></div><div class="spec-row"><span>Cap:</span><span>${COMPONENT_SPECS.battery.cap} Ah</span></div><div class="spec-row"><span>SOC:</span><span>${this.state.battAh.toFixed(1)}%</span></div><div class="spec-row"><span>Voltage:</span><span>${this.state.battV.toFixed(1)} V</span></div><div class="spec-row highlight-row"><span>Est. Runtime:</span><span>${autonomy}</span></div>`;
                } else if (type === 'pump') {
                    const power = this.state.activeValves > 0 ? COMPONENT_SPECS.pump.p_rate : 0;
                    html = `<div class="spec-row"><span>Model:</span><span>${COMPONENT_SPECS.pump.model}</span></div><div class="spec-row"><span>Max Flow:</span><span>${COMPONENT_SPECS.pump.flow_max} L/min</span></div><div class="spec-row"><span>Flow:</span><span>${this.state.pumpFlow.toFixed(2)} L/min</span></div><div class="spec-row"><span>Power:</span><span>${power} W</span></div>`;
                } else if (type === 'gateway') {
                    html = `<div class="spec-row"><span>Model:</span><span>SX1302-GW</span></div><div class="spec-row"><span>Freq:</span><span>868 MHz</span></div><div class="spec-row"><span>Active Nodes:</span><span>${this.state.activeValves} / 36</span></div><div class="spec-row"><span>Status:</span><span>Online</span></div>`;
                }
                tt.innerHTML = html;
            }

            toggleLogPanel() { document.body.classList.toggle('log-hidden'); }
            clearLog() { document.getElementById('log-console').innerHTML = ''; }

            updatePhysicsParams(val, type) {
                if(type === 'evap') {
                    this.params.evapFactor = val * 0.01;
                    const labels = ["Very Slow", "Slow", "Normal", "Fast", "Extreme"];
                    document.getElementById('disp-evap').innerText = labels[val-1];
                } else if (type === 'flow') {
                    this.params.irrigFactor = val * 0.25;
                    const labels = ["Trickle", "Slow", "Normal", "Fast", "Surge"];
                    document.getElementById('disp-flow').innerText = labels[val-1];
                }
            }

            initNodes() {
                const grid = document.getElementById('farm-grid');
                grid.innerHTML = '';
                this.state.zones = [];
                for(let i=0; i<36; i++) {
                    const node = { id: i, moist: this.params.initMoistBase + Math.random() * 20, isOpen: false, rssi: -70 - Math.floor(Math.random()*30) };
                    this.state.zones.push(node);
                    const div = document.createElement('div');
                    div.className = 'crop-unit';
                    div.id = `node-${i}`;
                    div.innerHTML = `<i class="fa-solid fa-wifi lora-ant"></i><div class="nozzle"></div><div class="moist-bar"><div class="moist-val" style="width:${node.moist}%"></div></div><span style="font-size:9px; margin-top:2px; color:#666">${Math.floor(node.moist)}%</span><div style="position:absolute; width:100%; height:100%; top:0; left:0" onmousemove="sim.showNodeTooltip(event, ${i})" onmouseleave="sim.hideNodeTooltip()"></div>`;
                    grid.appendChild(div);
                }
            }

            toggle() {
                const btn = document.getElementById('btn-toggle');
                if(this.isRunning) {
                    clearInterval(this.timer);
                    this.isRunning = false;
                    btn.innerHTML = '<i class="fa-solid fa-play"></i> Run';
                    btn.classList.remove('stop');
                    this.log("System Paused.");
                } else {
                    this.timer = setInterval(() => this.tick(), 1000);
                    this.isRunning = true;
                    btn.innerHTML = '<i class="fa-solid fa-pause"></i> Pause';
                    btn.classList.add('stop');
                    this.log("System Running.");
                }
            }

            reset() {
                clearInterval(this.timer);
                this.isRunning = false;
                this.state.time = 6 * 60;
                this.state.battAh = 100;
                this.hourlyStats = { waterL: 0, energyInWh: 0, energyOutWh: 0 };
                this.lastHourAvgConsumptionW = 0;
                this.initNodes();
                this.updateUI(0); 
                document.getElementById('btn-toggle').innerHTML = '<i class="fa-solid fa-play"></i> Run';
                document.getElementById('btn-toggle').classList.remove('stop');
                this.clearLog(); 
                this.log("System Reset Complete.");
            }

            tick() {
                const speed = parseInt(document.getElementById('speed-selector').value); 
                for(let i=0; i<speed; i++) {
                    this.processOneMinute();
                }
                const hour = this.state.time / 60;
                let uiIrradiance = 0;
                if (!this.params.forceCloudy && hour > this.params.sunrise && hour < this.params.sunset) {
                     const dayLen = this.params.sunset - this.params.sunrise;
                     const progress = (hour - this.params.sunrise) / dayLen;
                     uiIrradiance = Math.sin(progress * Math.PI) * this.params.maxSun;
                }
                this.updateUI(uiIrradiance);
            }

            processOneMinute() {
                this.state.time += 1;
                if(this.state.time >= 24*60) this.state.time = 0; 
                const hour = this.state.time / 60;

                let irradiance = 0;
                if (!this.params.forceCloudy && hour > this.params.sunrise && hour < this.params.sunset) {
                    const dayLen = this.params.sunset - this.params.sunrise;
                    const progress = (hour - this.params.sunrise) / dayLen;
                    irradiance = Math.sin(progress * Math.PI) * this.params.maxSun;
                    irradiance = Math.max(0, irradiance);
                }
                this.state.solarW = (irradiance / 1000) * COMPONENT_SPECS.solar.pmax;

                this.state.activeValves = 0;
                this.state.zones.forEach(node => {
                    if (node.moist < this.params.triggerMoist) node.isOpen = true;
                    if (node.moist >= this.params.targetMoist) node.isOpen = false;
                    if (node.isOpen) this.state.activeValves++;

                    const baseEvap = (irradiance > 100) ? this.params.evapFactor : (this.params.evapFactor * 0.25); 
                    node.moist -= baseEvap;
                    if (node.isOpen) node.moist += this.params.irrigFactor; 
                    node.moist = Math.max(0, Math.min(100, node.moist));
                });

                let currentLoadW = 0;
                let currentChargeW = this.state.solarW;
                if (this.state.activeValves > 0) {
                    this.state.pumpFlow = Math.min(this.state.activeValves * 0.05, COMPONENT_SPECS.pump.flow_max);
                    currentLoadW = COMPONENT_SPECS.pump.p_rate + (this.state.activeValves * COMPONENT_SPECS.node.p_active);
                } else {
                    this.state.pumpFlow = 0;
                    currentLoadW = 36 * COMPONENT_SPECS.node.p_idle; 
                }

                const drainAh = (currentLoadW / 12) * (1/60);
                const chargeAh = (currentChargeW / 14) * (1/60);
                this.state.battAh = Math.max(0, Math.min(100, this.state.battAh - drainAh + chargeAh));
                this.state.battV = 11.5 + (this.state.battAh/100)*1.8 + (this.state.solarW>0 ? 0.5 : 0);

                this.hourlyStats.waterL += this.state.pumpFlow; 
                this.hourlyStats.energyInWh += currentChargeW * (1/60);
                this.hourlyStats.energyOutWh += currentLoadW * (1/60);

                if(this.state.time % 60 === 0) this.performHourlyAudit();
            }

            performHourlyAudit() {
                const h = this.state.time / 60;
                const fmtTime = `${String(h === 0 ? 24 : h).padStart(2,'0')}:00`;
                this.lastHourAvgConsumptionW = this.hourlyStats.energyOutWh;
                this.logAudit(`[Hourly Audit ${fmtTime}] Water: ${this.hourlyStats.waterL.toFixed(2)} L | Gen: ${this.hourlyStats.energyInWh.toFixed(2)} Wh | Cons: ${this.hourlyStats.energyOutWh.toFixed(2)} Wh`);
                this.hourlyStats = { waterL: 0, energyInWh: 0, energyOutWh: 0 };
            }

            calculateAutonomy() {
                if (this.lastHourAvgConsumptionW <= 0.1) return "> 30 Days (Idle)";
                const totalEnergyWh = COMPONENT_SPECS.battery.v_nom * COMPONENT_SPECS.battery.cap;
                const currentEnergyWh = totalEnergyWh * (this.state.battAh / 100);
                const hoursLeft = currentEnergyWh / this.lastHourAvgConsumptionW;
                if (hoursLeft > 24) return `${(hoursLeft/24).toFixed(1)} Days`;
                return `${hoursLeft.toFixed(1)} Hours`;
            }

            updateUI(irradiance) {
                const h = Math.floor(this.state.time / 60);
                const m = this.state.time % 60;
                const timeStr = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                document.getElementById('sim-clock').innerText = timeStr;
                
                if (this.params.forceCloudy) {
                    document.getElementById('sim-weather').innerText = "Overcast";
                    document.getElementById('sun-icon').className = "fa-solid fa-cloud";
                } else if (irradiance > 100) {
                    document.getElementById('sim-weather').innerText = "Sunny";
                    document.getElementById('sun-icon').className = "fa-solid fa-sun";
                } else {
                    document.getElementById('sim-weather').innerText = "Night";
                    document.getElementById('sun-icon').className = "fa-solid fa-moon";
                }

                const autonomyStr = this.calculateAutonomy();
                document.getElementById('txt-solar').innerText = `${this.state.solarW.toFixed(1)} W | ${irradiance.toFixed(0)} W/m²`;
                document.getElementById('dot-solar').className = `status-dot ${this.state.solarW > 5 ? 'on' : ''}`;
                document.getElementById('txt-batt').innerText = `${this.state.battAh.toFixed(1)}% | ${this.state.battV.toFixed(1)}V`;
                
                const isPumping = this.state.activeValves > 0;
                document.getElementById('txt-pump').innerText = isPumping ? `ON | ${this.state.pumpFlow.toFixed(2)} L/m` : "OFF";
                document.getElementById('dot-pump').className = `status-dot ${isPumping ? 'on' : ''}`;
                
                document.getElementById('active-nodes').innerText = `Active: ${this.state.activeValves}/36`;
                this.state.zones.forEach(node => {
                    const el = document.getElementById(`node-${node.id}`);
                    const bar = el.querySelector('.moist-val');
                    const txt = el.querySelector('span');
                    bar.style.width = node.moist + '%';
                    txt.innerText = Math.floor(node.moist) + '%';
                    if(node.isOpen) { el.classList.add('watering'); el.classList.add('active'); } 
                    else { el.classList.remove('watering'); el.classList.remove('active'); }
                });

                if (this.hoveredComp) {
                    this.updateTooltipContent(this.hoveredComp);
                }
            }

            log(msg) {
                const box = document.getElementById('log-console');
                const h = Math.floor(this.state.time / 60);
                const m = this.state.time % 60;
                const timeStr = `[${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}]`;
                const line = document.createElement('div');
                line.className = 'log-line';
                line.innerHTML = `<span class="log-time">${timeStr}</span> ${msg}`;
                box.appendChild(line);
                box.scrollTop = box.scrollHeight;
                if(box.children.length > 200) box.removeChild(box.firstChild);
            }

            logAudit(msg) {
                const box = document.getElementById('log-console');
                const line = document.createElement('div');
                line.className = 'log-audit';
                line.innerText = msg;
                box.appendChild(line);
                box.scrollTop = box.scrollHeight;
            }

            showNodeTooltip(e, id) {
                const tt = document.getElementById('global-tooltip');
                const node = this.state.zones[id];
                tt.style.display = 'block';
                if(window.innerWidth < 1024) {
                    tt.style.left = '5%';
                    tt.style.top = (e.clientY + 20) + 'px';
                } else {
                    tt.style.left = (e.clientX + 15) + 'px';
                    tt.style.top = (e.clientY + 15) + 'px';
                }
                
                const html = `<div class="spec-row"><span>ID:</span><span>N-${String(id+1).padStart(2,'0')}</span></div><div class="spec-row"><span>Moist:</span><span>${node.moist.toFixed(1)}%</span></div><div class="spec-row"><span>Valve:</span><span style="color:${node.isOpen ? 'var(--success)' : '#ccc'}">${node.isOpen ? "OPEN" : "CLOSED"}</span></div><div class="spec-row"><span>Signal:</span><span>${node.rssi} dBm</span></div><div class="spec-row"><span>Power:</span><span>${node.isOpen ? COMPONENT_SPECS.node.p_active : COMPONENT_SPECS.node.p_idle} W</span></div>`;
                tt.innerHTML = html;
            }

            hideNodeTooltip() { document.getElementById('global-tooltip').style.display = 'none'; }
        }

        const sim = new Simulation();
    </script>
</body>
</html>